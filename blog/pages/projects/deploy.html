<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.0">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="https://x0.ifengimg.com/ucms/2022_33/D05072A8C8874827A94FA1CFE94705666831224C_size1_w64_h64.png"><script type="text/javascript">
		(function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "kgh215uzer");
    </script><title>可装配上线步骤的上线系统 - deploy | sword</title><meta name="description" content="Sword-Desc">
    <link rel="preload" href="/blog/assets/style-hc4LoWX0.css" as="style"><link rel="stylesheet" href="/blog/assets/style-hc4LoWX0.css">
    <link rel="modulepreload" href="/blog/assets/app-rZSHgSAN.js"><link rel="modulepreload" href="/blog/assets/deploy.html-NEcUfQKv.js"><link rel="modulepreload" href="/blog/assets/deploy.html-uI61mq6R.js">
    <link rel="prefetch" href="/blog/assets/index.html-P_5Ov_Q4.js" as="script"><link rel="prefetch" href="/blog/assets/config.html-jPdwSgwT.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-FFAP0xXC.js" as="script"><link rel="prefetch" href="/blog/assets/desc.html-4nGCZP_7.js" as="script"><link rel="prefetch" href="/blog/assets/fda.html-yeAfvPLM.js" as="script"><link rel="prefetch" href="/blog/assets/pc-site.html-jCGHCphh.js" as="script"><link rel="prefetch" href="/blog/assets/split.html-FZR65Uta.js" as="script"><link rel="prefetch" href="/blog/assets/desc.html-89Usx2Em.js" as="script"><link rel="prefetch" href="/blog/assets/howToAdd.html-8uVrKkNr.js" as="script"><link rel="prefetch" href="/blog/assets/optional.html-Fcz6JQ5l.js" as="script"><link rel="prefetch" href="/blog/assets/regexp.html-qZAc4ssJ.js" as="script"><link rel="prefetch" href="/blog/assets/copy.html-as5R2_Wx.js" as="script"><link rel="prefetch" href="/blog/assets/editableTable.html-CocfsEjN.js" as="script"><link rel="prefetch" href="/blog/assets/explain.html-Mfkt1kwv.js" as="script"><link rel="prefetch" href="/blog/assets/jsonviewer.html-DXAeIdXN.js" as="script"><link rel="prefetch" href="/blog/assets/labelInput.html-ERqi9wF7.js" as="script"><link rel="prefetch" href="/blog/assets/nametag.html-RPA9HDzs.js" as="script"><link rel="prefetch" href="/blog/assets/outlink.html-zsFRX-xT.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-6Yl8cQE3.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-oxMuEl3C.js" as="script"><link rel="prefetch" href="/blog/assets/config.html-3nKypKsW.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-rIKVhF4f.js" as="script"><link rel="prefetch" href="/blog/assets/desc.html-m4Fnj3iq.js" as="script"><link rel="prefetch" href="/blog/assets/fda.html-jGM9zxqF.js" as="script"><link rel="prefetch" href="/blog/assets/pc-site.html-TG4JAE9e.js" as="script"><link rel="prefetch" href="/blog/assets/split.html-NBm6KGWk.js" as="script"><link rel="prefetch" href="/blog/assets/desc.html-M4qSGMFb.js" as="script"><link rel="prefetch" href="/blog/assets/howToAdd.html-FhuOqYDV.js" as="script"><link rel="prefetch" href="/blog/assets/optional.html-3nl7eOMc.js" as="script"><link rel="prefetch" href="/blog/assets/regexp.html-s0ojvG9v.js" as="script"><link rel="prefetch" href="/blog/assets/copy.html-nHt0cxGQ.js" as="script"><link rel="prefetch" href="/blog/assets/editableTable.html-nzY5IKKv.js" as="script"><link rel="prefetch" href="/blog/assets/explain.html-HCrL5kDu.js" as="script"><link rel="prefetch" href="/blog/assets/jsonviewer.html-fK5vA4U-.js" as="script"><link rel="prefetch" href="/blog/assets/labelInput.html-Nje0MBsL.js" as="script"><link rel="prefetch" href="/blog/assets/nametag.html-jHgnUbM3.js" as="script"><link rel="prefetch" href="/blog/assets/outlink.html-YnycofyI.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-lSDLcp31.js" as="script"><link rel="prefetch" href="/blog/assets/Contact-wSinFu1a.js" as="script"><link rel="prefetch" href="/blog/assets/Copy-0W9X-eBc.js" as="script"><link rel="prefetch" href="/blog/assets/EditableTable-P5Upeia-.js" as="script"><link rel="prefetch" href="/blog/assets/Explain-Lo_OOjtM.js" as="script"><link rel="prefetch" href="/blog/assets/Iframe-9nQ7d5Z0.js" as="script"><link rel="prefetch" href="/blog/assets/LabelInput-j-G3tOXu.js" as="script"><link rel="prefetch" href="/blog/assets/NameTag-eDjk6EQN.js" as="script"><link rel="prefetch" href="/blog/assets/Outlink-FQkMF9lG.js" as="script"><link rel="prefetch" href="/blog/assets/PartTitle-ZUIbxV7w.js" as="script"><link rel="prefetch" href="/blog/assets/RegExpTest-jn0Z5trQ.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/blog/" class=""><img class="logo" src="http://i1.letvimg.com/lc03_lemf/202301/17/16/18/cheems.jpg" alt="sword"><span class="site-name can-hide">sword</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/blog/" class="" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/pages/projects/pc-site" class="router-link-active" aria-label="项目"><!--[--><!--]--> 项目 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/pages/components/common/copy" class="" aria-label="组件"><!--[--><!--]--> 组件 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/pages/learn/regexp" class="" aria-label="学习笔记"><!--[--><!--]--> 学习笔记 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/ImSwordTooth" rel="noopener noreferrer" target="_blank" aria-label="github"><!--[--><!--]--> github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><!----><form class="search-box" role="search"><input type="search" placeholder="搜索..." autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/blog/" class="" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/pages/projects/pc-site" class="router-link-active" aria-label="项目"><!--[--><!--]--> 项目 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/pages/components/common/copy" class="" aria-label="组件"><!--[--><!--]--> 组件 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/pages/learn/regexp" class="" aria-label="学习笔记"><!--[--><!--]--> 学习笔记 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/ImSwordTooth" rel="noopener noreferrer" target="_blank" aria-label="github"><!--[--><!--]--> github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active">项目 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/blog/pages/projects/pc-site.html" class="sidebar-item" aria-label="pc-site 说明"><!--[--><!--]--> pc-site 说明 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/pages/projects/deploy.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="可装配上线步骤的上线系统 - deploy"><!--[--><!--]--> 可装配上线步骤的上线系统 - deploy <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/pages/projects/deploy.html#一、登录" class="router-link-active router-link-exact-active sidebar-item" aria-label="一、登录"><!--[--><!--]--> 一、登录 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/pages/projects/deploy.html#二、项目列表、分支列表和-commit-列表" class="router-link-active router-link-exact-active sidebar-item" aria-label="二、项目列表、分支列表和 commit 列表"><!--[--><!--]--> 二、项目列表、分支列表和 commit 列表 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/pages/projects/deploy.html#三、上线步骤" class="router-link-active router-link-exact-active sidebar-item" aria-label="三、上线步骤"><!--[--><!--]--> 三、上线步骤 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/pages/projects/deploy.html#四、执行上线与保存日志" class="router-link-active router-link-exact-active sidebar-item" aria-label="四、执行上线与保存日志"><!--[--><!--]--> 四、执行上线与保存日志 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/blog/pages/projects/fda.html" class="sidebar-item" aria-label="搭建系统 - fda"><!--[--><!--]--> 搭建系统 - fda <!--[--><!--]--></a><!----></li><li><a href="/blog/pages/projects/split.html" class="sidebar-item" aria-label="设计图裁剪工具 - split"><!--[--><!--]--> 设计图裁剪工具 - split <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="可装配上线步骤的上线系统-deploy" tabindex="-1"><a class="header-anchor" href="#可装配上线步骤的上线系统-deploy" aria-hidden="true">#</a> 可装配上线步骤的上线系统 - deploy</h1><p>公司旧有的上线系统操作繁琐，需要用户多次操作才能完成。<br> 并且结构固定，想要接入新的上线项目，必须要改源码才能完成。</p><p>于是本人做了一个新的系统。整理出一些通用的、可配置的步骤，制作成可直接使用的物料，新增或修改上线流程时可直接套用。<br> 技术点：<code>vue</code>、<code>webpack</code>、<code>OAuth 登录</code>、<code>MongoDB 存储数据</code>、<code>socket.io 建立连接</code>、<code>node-pty 流式传输</code></p><p><img src="https://i3.letvimg.com/lc16_lemf/202311/23/15/19/Snipaste_2023-11-23_15-18-17.png" alt="主页"></p><h3 id="一、登录" tabindex="-1"><a class="header-anchor" href="#一、登录" aria-hidden="true">#</a> 一、登录</h3><p>使用了<code>OAuth</code>连接到了 gitlab 登录，免去了手动登录的麻烦，也不用费心思琢磨公司用的 <strong>LDAP</strong> 登录</p><h3 id="二、项目列表、分支列表和-commit-列表" tabindex="-1"><a class="header-anchor" href="#二、项目列表、分支列表和-commit-列表" aria-hidden="true">#</a> 二、项目列表、分支列表和 commit 列表</h3><p>对于项目列表，因为“<strong>要上线的项目</strong>”和“<strong>我拥有的项目</strong>”不是同一个东西，因此放在数据库的表里。<br> 分支列表和 commit 列表则是通过<code>OAuth</code>获取到的 token，使用 gitlab 的 api 获取。</p><h3 id="三、上线步骤" tabindex="-1"><a class="header-anchor" href="#三、上线步骤" aria-hidden="true">#</a> 三、上线步骤</h3><p>上线步骤是本系统的核心概念。<br> 用户可以在“上线步骤” tab 里去增删改步骤。不管怎么改，只要符合规范，就能在不动源码的情况下，随意组合出大量复杂的、不同的上线流程。<br><img src="https://i3.letvimg.com/lc15_lemf/202311/23/16/26/Snipaste_2023-11-23_16-24-17.png" alt="上线步骤"><br> 步骤类型分为三种：</p><h4 id="_1-固定步骤" tabindex="-1"><a class="header-anchor" href="#_1-固定步骤" aria-hidden="true">#</a> 1.固定步骤</h4><p>预设的流程，一般用于数值、流程较为固定的步骤，比如克隆代码、<code>npm install</code>、<code>npm run build</code> 等<br><img src="https://i3.letvimg.com/lc16_lemf/202311/23/16/31/Snipaste_2023-11-23_16-29-20.png" alt=""></p><h4 id="_2-命令步骤" tabindex="-1"><a class="header-anchor" href="#_2-命令步骤" aria-hidden="true">#</a> 2.命令步骤</h4><p>可以输入要执行的 linux 命令，在服务器上直接执行填写的语句。<br> 如果命令中需要参数，本项目有一些预设的参数，如项目名称、选择的分支等。 <img src="https://i3.letvimg.com/lc14_lemf/202311/23/16/35/Snipaste_2023-11-23_16-35-40.png" alt=""></p><h4 id="_3-特殊步骤" tabindex="-1"><a class="header-anchor" href="#_3-特殊步骤" aria-hidden="true">#</a> 3.特殊步骤</h4><p>有些上线流程特殊值很多，难以通过封装的方法提取公共点，所以如有特殊情况，可去修改源码。 <img src="https://i1.letvimg.com/lc16_lemf/202311/23/16/36/Snipaste_2023-11-23_16-35-08.png" alt=""><br> 填写完毕后，以步骤的 key 为基本，可以删除或者修改步骤的顺序。<br> 对于后端来说，<strong>一个个步骤就是一个对象，完整的流程就是一个对象数组</strong>，和上线项目、上线分支等结合起来，就是一个完整的项目上线流程。</p><h3 id="四、执行上线与保存日志" tabindex="-1"><a class="header-anchor" href="#四、执行上线与保存日志" aria-hidden="true">#</a> 四、执行上线与保存日志</h3><p>前端发起请求之后，<code>socket.io</code> 建立连接，寻找数据库中对于的上线流程，一步步执行下来，只有上一步成功了才会继续下一步。<br> 执行的过程中，一边把日志以 <code>websocket</code> 的方式实时传输到前端，一边保存到日志库里，方便后续查询。 上线日志一开始用的是 <code>node</code> 原生的 <code>spawn</code> 或者 <code>exec</code>，体验下来感官并不好，不仅慢，数据是一堆一堆出来的，而且会损失日志内容。<br> 后来查到了 <code>node-pty</code> 这个库，原本似乎是 <code>node</code> 端用来模拟终端的。<code>node-pty</code> 下面的 <code>spawn</code> 方法可以监听流式传输的内容，并且速度快且不损失内容，还能保留字符的 anti 码，可以完整地还原日志的字号、颜色等。 <img src="https://i2.letvimg.com/lc15_lemf/202311/23/16/49/Snipaste_2023-11-23_16-48-52.png" alt=""></p></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/ImSwordTooth/edit/main/pages/projects/deploy.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/blog/pages/projects/pc-site.html" class="" aria-label="pc-site 说明"><!--[--><!--]--> pc-site 说明 <!--[--><!--]--></a></span><span class="next"><a href="/blog/pages/projects/fda.html" class="" aria-label="搭建系统 - fda"><!--[--><!--]--> 搭建系统 - fda <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/blog/assets/app-rZSHgSAN.js" defer></script>
  </body>
</html>
